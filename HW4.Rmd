---
title: "Music Physiological Response Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: cosmo
date: "2025-02-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10, 
  fig.height = 6,
  out.width = "100%"
)
```

## 1. Load Packages and Set Theme

```{r packages}
# Load necessary packages
library(tidyverse)
library(data.table)
library(lubridate)
library(lme4)      # For mixed linear models
library(lmerTest)  # For p-values in mixed models
library(sjPlot)    # For model visualization
library(ggplot2)   # For visualization
library(patchwork) # For combining plots
library(scales)    # For better axis formatting
library(psych)     # For descriptive statistics

# Set a consistent theme for all plots
theme_set(theme_minimal(base_size = 12) + 
          theme(legend.position = "bottom",
                panel.grid.minor = element_blank()))
```

## 3. Load and Process Downsampled Data

```{r}


# Load the downsampled data from CSV (replace with your actual file path)
continuous_data_1Hz <- read.csv("C:/Users/Elias/Documents/continuous_data_1Hz_avg.csv")

# Make sure all numeric columns are properly typed
numeric_cols <- c("Time", "RelativeTime", "BVP", "Corr", "Resp", "Skin", "Temp", "Trap", "Zygo")
continuous_data_1Hz[numeric_cols] <- lapply(continuous_data_1Hz[numeric_cols], as.numeric)

# Convert categorical variables to factors if needed
factor_cols <- c("Participant", "Session", "StimID", "StimOrder")
continuous_data_1Hz[factor_cols] <- lapply(continuous_data_1Hz[factor_cols], as.factor)

# Load post-stimulus data
post_stim_files <- list.files(
  path = "C:/Users/Elias/Downloads/5632210",
  pattern = glob2rx("PostStimulus_Numeric*.csv"), 
  recursive = TRUE,
  full.names = TRUE
)

cat("Processing", length(post_stim_files), "post-stimulus files...\n")
post_stimulus_list <- lapply(post_stim_files, read_post_stimulus)
post_stimulus_list <- post_stimulus_list[!sapply(post_stimulus_list, is.null)]
post_stimulus_data <- bind_rows(post_stimulus_list)
cat("Loaded", nrow(post_stimulus_data), "rows of post-stimulus data\n")

# Load stimulus metadata (if not included in the downsampled data)
# Only needed if the metadata wasn't joined to your data before downsampling
if(!"Title" %in% names(continuous_data_1Hz)) {
  stimulus_metadata <- tibble(
    StimID = c(101, 102, 103, 104, 105, 106, 107, 
               211, 212, 213, 214, 
               221, 222, 223, 224, 
               231, 232, 233, 234, 
               241, 242, 243, 244),
    # Rest of metadata as in your original code
    # ...
  )
  # Join metadata to the downsampled data
  continuous_data_1Hz <- continuous_data_1Hz %>%
    left_join(stimulus_metadata, by = "StimID")
}


```
Plot
```{r}
# Visualization to confirm no extreme outliers remain
cleaned_boxplots <- cleaned_continuous %>%
  pivot_longer(cols = c(BVP, Corr, Resp, Skin, Temp, Trap, Zygo), 
               names_to = "Measure", values_to = "Value") %>%
  ggplot(aes(x = Measure, y = Value)) +
  geom_boxplot() +
  facet_wrap(~Measure, scales = "free_y") +
  labs(title = "Distributions of Cleaned Physiological Measures",
       y = "Value") +
  theme(axis.text.x = element_blank())

print(cleaned_boxplots)
cleaned_continuous
```

### 4.3 Physiological Signal Feature Extraction

```{r feature_extraction}
# Calculate more advanced physiological features
physio_features <- cleaned_continuous %>%
  # Group by each stimulus presentation
  group_by(Participant, Session, StimOrder, StimID) %>%
  summarize(
    # Time domain features
    mean_BVP = mean(BVP, na.rm = TRUE),
    sd_BVP = sd(BVP, na.rm = TRUE),
    
    # BVP features - calculate heart rate variability approximation
    # First 20 seconds often contains adaptation, so we'll use data after that
    # Assuming 100Hz sampling rate
    hr_var = if(n() > 3000) sd(BVP[RelativeTime >= 20], na.rm = TRUE) else NA,
    
    # Skin conductance features
    mean_Skin = mean(Skin, na.rm = TRUE),
    sd_Skin = sd(Skin, na.rm = TRUE),
    # Calculate skin conductance response frequency (SCR)
    # Simple approximation: count instances where skin conductance increases by 0.05 units within 3 seconds
    scr_count = sum(diff(Skin) > 0.05, na.rm = TRUE),
    scr_rate = scr_count / (max(RelativeTime, na.rm = TRUE) / 60), # per minute
    
    # Respiratory features
    mean_Resp = mean(Resp, na.rm = TRUE),
    sd_Resp = sd(Resp, na.rm = TRUE),
    # Improved respiration rate calculation using zero crossings with filtering
    resp_rate = sum(diff(sign(Resp - mean(Resp, na.rm = TRUE))) != 0, na.rm = TRUE) / 
               (2 * max(RelativeTime, na.rm = TRUE) / 60), # divide by 2 to count full cycles
    
    # EMG features (facial expressions)
    mean_Corr = mean(Corr, na.rm = TRUE), # Corrugator - frowning
    sd_Corr = sd(Corr, na.rm = TRUE),
    mean_Zygo = mean(Zygo, na.rm = TRUE), # Zygomaticus - smiling
    sd_Zygo = sd(Zygo, na.rm = TRUE),
    mean_Trap = mean(Trap, na.rm = TRUE), # Trapezius - tension
    sd_Trap = sd(Trap, na.rm = TRUE),
    
    # Ratio of positive to negative facial expression (smiling vs frowning)
    smile_frown_ratio = mean_Zygo / mean_Corr,
    
    # Stimulus duration
    stim_duration = max(RelativeTime, na.rm = TRUE),
    
    # Calculate emotional metrics if available
    has_emotion_data = "EmotionalArousal" %in% names(.) & "EmotionalValence" %in% names(.),
    mean_arousal = if("EmotionalArousal" %in% names(.)) 
                      mean(EmotionalArousal, na.rm = TRUE) else NA,
    mean_valence = if("EmotionalValence" %in% names(.)) 
                      mean(EmotionalValence, na.rm = TRUE) else NA,
    
    # Calculate time trends - early vs. late response
    # Early: first third, Late: last third
    early_Skin = if(n() > 300) mean(Skin[RelativeTime <= quantile(RelativeTime, 0.33)], na.rm = TRUE) else NA,
    late_Skin = if(n() > 300) mean(Skin[RelativeTime >= quantile(RelativeTime, 0.67)], na.rm = TRUE) else NA,
    skin_change = late_Skin - early_Skin,
    
    early_Zygo = if(n() > 300) mean(Zygo[RelativeTime <= quantile(RelativeTime, 0.33)], na.rm = TRUE) else NA,
    late_Zygo = if(n() > 300) mean(Zygo[RelativeTime >= quantile(RelativeTime, 0.67)], na.rm = TRUE) else NA,
    zygo_change = late_Zygo - early_Zygo,
    
    # Sample count
    n_samples = n()
  )
```

### 4.4 Create Analysis Dataset

```{r analysis_dataset}
# Create analysis dataset by joining feature data with post-stimulus data
analysis_data <- physio_features %>%
  left_join(post_stimulus_data, by = c("Participant", "Session", "StimOrder", "StimID")) %>%
  left_join(stimulus_metadata, by = "StimID") %>%
  # Convert binary responses to logical for better interpretation
  mutate(across(c(Cough, Sneeze, Laugh, Doze, Yawn, ShiverChills, MoveToMusic, Other, 
                 ExperimentSelected, ParticipantSelected), 
                ~as.logical(as.numeric(.)))) %>%
  # Scale emotion ratings to 0-100 for interpretability
  mutate(
    Familiarity_pct = Familiarity / 1.27,
    Liking_pct = Liking / 1.27,
    Focus_pct = Focus / 1.27,
    SelfConsciousness_pct = SelfConsciousness / 1.27
  ) %>%
  # Final cleaning and quality flags
  mutate(
    data_quality_flag = case_when(
      Interrupted == 1 ~ "interrupted",
      is.na(resp_rate) | resp_rate < 8 | resp_rate > 25 ~ "abnormal_resp_rate",
      is.na(mean_BVP) | is.na(mean_Skin) ~ "missing_key_data",
      n_samples < 1000 ~ "insufficient_data",
      TRUE ~ "ok"
    ),
    # Create musical arousal proxy based on genre
    musical_arousal_proxy = case_when(
      Genre %in% c("Hip-hop/Rap", "Electronic Dance Music", "Rock", "Dubstep/Glitch-hop") ~ "high",
      Genre %in% c("Classical", "Baroque", "Soundtrack", "French Canadian Folksong", "Piano") ~ "low",
      TRUE ~ "medium"
    )
  )

# Check if we have any recordings with quality issues
quality_summary <- analysis_data %>%
  count(data_quality_flag) %>%
  mutate(percentage = n / sum(n) * 100)

print(quality_summary)
```

## 5. Exploratory Data Analysis

### 5.1 Overview of Dataset

```{r data_overview}
# Data overview - how many stimuli, sessions, etc.
data_counts <- analysis_data %>%
  summarize(
    n_sessions = n_distinct(Session),
    n_stimuli = n_distinct(StimID),
    n_observations = n(),
    n_experiment_selected = sum(ExperimentSelected, na.rm = TRUE),
    n_participant_selected = sum(ParticipantSelected, na.rm = TRUE)
  )

print(data_counts)

# Distribution of stimuli by genre
genre_distribution <- analysis_data %>%
  group_by(Genre) %>%
  summarize(
    count = n(),
    mean_liking = mean(Liking_pct, na.rm = TRUE),
    mean_familiarity = mean(Familiarity_pct, na.rm = TRUE)
  ) %>%
  arrange(desc(count))

print(genre_distribution)

# Visualize distribution of stimuli by genre with liking scores
genre_plot <- ggplot(genre_distribution, aes(x = reorder(Genre, -count), y = count, fill = mean_liking)) +
  geom_col() +
  scale_fill_viridis_c(option = "plasma", name = "Mean Liking (%)") +
  labs(title = "Distribution of Stimuli by Genre with Liking Scores",
       x = "Genre", y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(genre_plot)
```

### 5.2 Descriptive Statistics for Key Variables

```{r descriptive_stats}
# Descriptive statistics for all numeric variables
descriptive_stats <- analysis_data %>%
  select(where(is.numeric), -ends_with("Time"), -contains("ID"), -Session, -Participant) %>%
  select(-Interrupted, -starts_with("Stim")) %>%
  psych::describe() %>%
  select(n, mean, sd, median, min, max, skew, kurtosis)

print(descriptive_stats)

# Compare physiological responses across genre categories
physio_by_genre <- analysis_data %>%
  group_by(GenreCategory) %>%
  summarize(
    mean_skin = mean(mean_Skin, na.rm = TRUE),
    sd_skin = sd(mean_Skin, na.rm = TRUE),
    mean_scr_rate = mean(scr_rate, na.rm = TRUE),
    mean_resp_rate = mean(resp_rate, na.rm = TRUE),
    mean_smile = mean(mean_Zygo, na.rm = TRUE),
    mean_frown = mean(mean_Corr, na.rm = TRUE),
    mean_liking = mean(Liking_pct, na.rm = TRUE),
    n = n()
  )

print(physio_by_genre)

# Visualize physiological responses by genre
physio_genre_plot <- physio_by_genre %>%
  pivot_longer(cols = starts_with("mean_"), names_to = "measure", values_to = "value") %>%
  ggplot(aes(x = GenreCategory, y = value, fill = GenreCategory)) +
  geom_col() +
  facet_wrap(~measure, scales = "free_y") +
  labs(title = "Physiological Responses by Genre Category",
       x = "Genre Category", y = "Value") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

print(physio_genre_plot)
```

### 5.3 Relationship between Subjective and Physiological Responses

```{r subjective_physio_relationship}
# Create correlation matrix for key variables
correlation_vars <- analysis_data %>%
  filter(data_quality_flag == "ok") %>%
  select(mean_Skin, scr_rate, mean_Zygo, mean_Corr, smile_frown_ratio, 
         Liking_pct, Familiarity_pct, Focus_pct, SelfConsciousness_pct)

correlation_matrix <- cor(correlation_vars, use = "pairwise.complete.obs")
corrplot::corrplot(correlation_matrix, method = "circle", type = "upper", 
                   tl.col = "black", tl.srt = 45, addCoef.col = "black", 
                   number.cex = 0.7)

# Explore relationship between liking and physiological responses
liking_plots <- analysis_data %>%
  filter(data_quality_flag == "ok") %>%
  select(Liking_pct, mean_Skin, mean_Zygo, mean_Corr, smile_frown_ratio) %>%
  pivot_longer(cols = c(mean_Skin, mean_Zygo, mean_Corr, smile_frown_ratio), 
               names_to = "measure", values_to = "value") %>%
  ggplot(aes(x = Liking_pct, y = value)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", se = TRUE) +
  facet_wrap(~measure, scales = "free_y") +
  labs(title = "Relationship between Liking and Physiological Responses",
       x = "Liking (%)", y = "Value")

print(liking_plots)

# Visualize emotional reactions across sessions
emotion_by_session <- analysis_data %>%
  group_by(Session) %>%
  summarize(
    mean_liking = mean(Liking_pct, na.rm = TRUE),
    mean_familiarity = mean(Familiarity_pct, na.rm = TRUE),
    mean_focus = mean(Focus_pct, na.rm = TRUE),
    mean_self_consciousness = mean(SelfConsciousness_pct, na.rm = TRUE),
    mean_skin = mean(mean_Skin, na.rm = TRUE),
    mean_zygo = mean(mean_Zygo, na.rm = TRUE)
  ) %>%
  pivot_longer(cols = starts_with("mean_"), names_to = "measure", values_to = "value")

session_emotion_plot <- ggplot(emotion_by_session, aes(x = Session, y = value, group = measure, color = measure)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~measure, scales = "free_y") +
  labs(title = "Changes in Emotional and Physiological Responses Across Sessions",
       x = "Session Number", y = "Value") +
  theme(legend.position = "none")

print(session_emotion_plot)
```

### 5.4 Response Patterns for Familiar vs. Unfamiliar Music

```{r familiar_unfamiliar}
# Create binary familiarity variable for analysis
analysis_data <- analysis_data %>%
  mutate(
    is_familiar = Familiarity_pct >= 50,
    is_liked = Liking_pct >= 50
  )

# Compare responses to familiar vs. unfamiliar music
familiarity_comparison <- analysis_data %>%
  group_by(is_familiar) %>%
  summarize(
    n = n(),
    mean_liking = mean(Liking_pct, na.rm = TRUE),
    mean_focus = mean(Focus_pct, na.rm = TRUE),
    mean_self_consciousness = mean(SelfConsciousness_pct, na.rm = TRUE),
    mean_skin = mean(mean_Skin, na.rm = TRUE),
    mean_zygo = mean(mean_Zygo, na.rm = TRUE),
    mean_corr = mean(mean_Corr, na.rm = TRUE),
    smile_ratio = mean(smile_frown_ratio, na.rm = TRUE),
    laughed_pct = mean(Laugh, na.rm = TRUE) * 100,
    moved_to_music_pct = mean(MoveToMusic, na.rm = TRUE) * 100,
  )

print(familiarity_comparison)

# Visualize key differences between familiar and unfamiliar music
familiarity_plots <- analysis_data %>%
  pivot_longer(cols = c(mean_Skin, mean_Zygo, mean_Corr, smile_frown_ratio), 
               names_to = "measure", values_to = "value") %>%
  ggplot(aes(x = is_familiar, y = value, fill = is_
